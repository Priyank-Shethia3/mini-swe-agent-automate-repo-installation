"""
Karma test log parser.
"""

import re
from enum import Enum


class TestStatus(Enum):
    PASSED = "PASSED"
    FAILED = "FAILED"
    SKIPPED = "SKIPPED"


def parse_log_karma(log: str) -> dict[str, str]:
    """
    Parser for test logs generated by Karma (Jasmine runner).

    Karma outputs progress lines like:
        Chrome Headless 137.0.0.0 (Linux x86_64): Executed 108 of 108 SUCCESS (0.574 secs / 0.515 secs)
        Chrome Headless 137.0.0.0 (Linux x86_64): Executed 1 of 10 (1 FAILED) (0.1 secs / 0.05 secs)

    Since Karma doesn't output individual test names in a parseable way,
    we generate generic test entries based on the summary counts.

    Args:
        log (str): log content
    Returns:
        dict: test case to test status mapping
    """
    test_status_map = {}

    # Pattern for Karma final summary
    # Matches: "Executed 108 of 108 SUCCESS" or "Executed 100 of 108 (8 FAILED)"
    success_pattern = r"Executed\s+(\d+)\s+of\s+\d+\s+SUCCESS"
    failed_pattern = r"Executed\s+\d+\s+of\s+\d+\s+\((\d+)\s+FAILED\)"
    skipped_pattern = r"Executed\s+\d+\s+of\s+(\d+)\s+\((\d+)\s+skipped\)"

    # Look for the final summary line
    passed_count = 0
    failed_count = 0
    skipped_count = 0

    for line in log.split("\n"):
        # Check for success pattern
        success_match = re.search(success_pattern, line)
        if success_match:
            passed_count = max(passed_count, int(success_match.group(1)))

        # Check for failed pattern
        failed_match = re.search(failed_pattern, line)
        if failed_match:
            failed_count = max(failed_count, int(failed_match.group(1)))

        # Check for skipped pattern
        skipped_match = re.search(skipped_pattern, line)
        if skipped_match:
            skipped_count = max(skipped_count, int(skipped_match.group(2)))

    # Generate test entries based on counts
    # Since we don't have individual test names, create generic entries
    for i in range(passed_count):
        test_name = f"karma_unit_test_{i + 1}"
        test_status_map[test_name] = TestStatus.PASSED.value

    for i in range(failed_count):
        test_name = f"karma_unit_test_failed_{i + 1}"
        test_status_map[test_name] = TestStatus.FAILED.value

    for i in range(skipped_count):
        test_name = f"karma_unit_test_skipped_{i + 1}"
        test_status_map[test_name] = TestStatus.SKIPPED.value

    return test_status_map
